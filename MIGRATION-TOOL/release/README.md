# LeiaSR Display API Migration Tool

Automated migration tool for converting legacy LeiaSR Display API code to the modern IDisplayManager interface.

## Overview

This tool automatically migrates C++ code from the legacy `SR::Display` API to the modern `SR::IDisplayManager` pattern. **Version 1.2.0** introduces two migration modes:

### Modern Mode (DEFAULT - Recommended)
- Direct IDisplayManager API migration
- Clean, simple code without helper files
- Requires SDK 1.34.8-RC1 or later runtime

### Legacy Fallback Mode (use `--legacy-fallback`)
- Runtime fallback to legacy Display class
- Auto-generates display_helper.h helper
- Compatible with older SDK runtimes

### What It Does

- **Detects** legacy Display API usage patterns in your C++ codebase
- **Analyzes** migration needs with confidence scoring
- **Transforms** code safely with automatic backups
- **Two migration modes**: Modern (clean) or Legacy (backward compatible)
- **Provides** rollback capability via `.legacy` backup files

## Requirements

- Windows 10 or later
- No Python installation required
- LeiaSR SDK 1.34.8-RC1 or later

## Installation

Simply extract the release package - the standalone executable `leiasr-migrate.exe` is ready to use immediately!

## Usage

### 1. Analyze Your Code

First, analyze your project to see what needs migration:

```cmd
leiasr-migrate.exe analyze C:\path\to\your\project
```

Save the analysis report to a file:

```cmd
leiasr-migrate.exe analyze C:\path\to\your\project --report=analysis.txt
```

### 2. Test Migration (Dry Run)

See what changes would be made without actually modifying files:

```cmd
leiasr-migrate.exe migrate C:\path\to\your\project --dry-run
```

### 3. Perform Migration

**Modern Mode (DEFAULT - Recommended)**:

```cmd
leiasr-migrate.exe migrate C:\path\to\your\project
```

This performs a clean migration to IDisplayManager without helper files.

**Legacy Fallback Mode** (for backward compatibility):

```cmd
leiasr-migrate.exe migrate C:\path\to\your\project --legacy-fallback
```

This creates `display_helper.h` with runtime fallback to legacy Display class.

**Skip confirmation prompt**:

```cmd
leiasr-migrate.exe migrate C:\path\to\your\project --yes
```

## What Gets Migrated

### Before (Legacy API)

```cpp
#include "sr/world/display/display.h"

SR::Display* display = SR::Display::create(context);
int width = display->getResolutionWidth();
int height = display->getResolutionHeight();
```

### After - Modern Mode (DEFAULT)

```cpp
#include "sr/world/display/display.h"

SR::IDisplayManager* displayMgr_display = SR::GetDisplayManagerInstance(context);
SR::IDisplay* display = displayMgr_display->getPrimaryActiveSRDisplay();
int width = display->getResolutionWidth();
int height = display->getResolutionHeight();
```

### After - Legacy Fallback Mode (`--legacy-fallback`)

```cpp
#define SRDISPLAY_LAZYBINDING  // Enable modern DisplayManager with fallback
#include "sr/world/display/display.h"
#include "display_helper.h"  // Auto-generated by migration tool

SR::Helper::DisplayAccess display(context);
int width = display.getResolutionWidth();
int height = display.getResolutionHeight();
```

## How the Migration Tool Works

The tool performs different transformations based on the migration mode:

### Modern Mode (DEFAULT)

1. **Code Transformations**:
   - Converts `SR::Display::create()` to `SR::IDisplayManager::create()`
   - Adds call to `getPrimaryActiveSRDisplay()` to get IDisplay pointer
   - Keeps pointer syntax (`->`) unchanged
   - No helper files created

2. **Backup Original Files**:
   - Renames original files to `.legacy` extension for safe rollback

### Legacy Fallback Mode (`--legacy-fallback`)

1. **Auto-Generate Helper File**:
   - Creates `display_helper.h` (252 lines) in your project directory
   - Contains `DisplayAccess` helper class
   - Provides modern `IDisplayManager` API access with automatic fallback
   - Includes legacy `Display*` compatibility layer

2. **Code Transformations**:
   - Adds `SRDISPLAY_LAZYBINDING` define before display.h include
   - Adds `#include "display_helper.h"`
   - Converts `SR::Display*` pointers to `SR::Helper::DisplayAccess` objects
   - Changes pointer syntax (`->`) to direct access (`.`)

3. **Backup Original Files**:
   - Renames original files to `.legacy` extension for safe rollback

## Detection Patterns

The analyzer detects:

- Legacy display.h includes without lazy binding
- `SR::Display::create()` calls
- Display method calls that need validity checking
- Manual display polling loops
- Manual nullptr checks

## Confidence Levels

- **High**: Safe for automatic migration (includes, Display::create)
- **Medium**: Review recommended (inline creates, method calls)
- **Low**: Manual review required (complex control flow)

## Example Workflow

```cmd
REM 1. Analyze your project
leiasr-migrate.exe analyze C:\my_leiasr_app --report=migration_report.txt

REM 2. Review the report
type migration_report.txt

REM 3. Test migration with dry-run
leiasr-migrate.exe migrate C:\my_leiasr_app --dry-run

REM 4. Perform actual migration
leiasr-migrate.exe migrate C:\my_leiasr_app --yes

REM 5. Verify display_helper.h was created
dir C:\my_leiasr_app\display_helper.h

REM 6. Test your application
cd C:\my_leiasr_app
cmake --build build --config Release
build\Release\my_app.exe

REM 7. If everything works, delete .legacy files
del /S C:\my_leiasr_app\*.legacy
```

## Output Files

- **display_helper.h**: Auto-generated helper class (252 lines)
- **Original files**: Renamed to `filename.ext.legacy`
- **Migrated files**: Modern code written to original filename
- **Reports**: Analysis and transformation details (optional)

## Safety Features

- ✅ Original files preserved with .legacy extension
- ✅ Dry-run mode to preview changes
- ✅ Confirmation prompts (skip with --yes)
- ✅ Detailed transformation reports
- ✅ Easy to compare migrated vs original
- ✅ No modifications during analysis

## Command Reference

### analyze

```cmd
leiasr-migrate.exe analyze <path> [--report FILE] [--no-recursive]
```

**Parameters:**
- `<path>`: File or directory to analyze
- `--report FILE`: Save analysis report to file
- `--no-recursive`: Don't recurse into subdirectories

**Example:**
```cmd
leiasr-migrate.exe analyze C:\MyProject --report=analysis.txt
```

### migrate

```cmd
leiasr-migrate.exe migrate <path> [--dry-run] [--yes] [--report FILE] [--no-recursive]
```

**Parameters:**
- `<path>`: File or directory to migrate
- `--dry-run`: Show changes without modifying files
- `--yes`: Skip confirmation prompt
- `--report FILE`: Save transformation report to file
- `--no-recursive`: Don't recurse into subdirectories

**Example:**
```cmd
leiasr-migrate.exe migrate C:\MyProject --dry-run
leiasr-migrate.exe migrate C:\MyProject --yes
```

## What You Need

Before using this tool:

1. **LeiaSR SDK**: Version 1.34.8-RC1 or later (with IDisplayManager support)
2. **CMake Configuration**: Add `-DSRDISPLAY_LAZYBINDING` to your CMakeLists.txt after migration

**Note**: The tool automatically creates `display_helper.h` - no manual setup required!

## Next Steps After Migration

1. **Review Changes**: Check the transformation report and verify display_helper.h was created
2. **Compare Files**: Use `fc` or any diff tool to compare `.legacy` files with migrated versions
   ```cmd
   fc /n main.cpp.legacy main.cpp
   ```
3. **Update CMakeLists.txt**: Add the lazy binding definition
   ```cmake
   add_definitions(-DSRDISPLAY_LAZYBINDING)
   ```
4. **Test Build**: Verify your project compiles
   ```cmd
   cmake --build build --config Release
   ```
5. **Test Runtime**: Run with both old and new SDK runtimes to verify compatibility
6. **Add Validity Checks**: Wrap display usage with validity checks
   ```cpp
   if (display.isDisplayValid()) {
       // Use display
   }
   ```
7. **Clean Up**: Delete `.legacy` files once satisfied
   ```cmd
   del /S *.legacy
   ```

## Troubleshooting

### "No files require migration"

**Possible causes:**
- Check that your files use `#include "sr/world/display/display.h"`
- Verify you're targeting the right directory
- Files may already be migrated
- Run analyze command first to see what was detected

### Build Errors After Migration

**Common fixes:**
- Verify `display_helper.h` was created in your project directory
- Add `-DSRDISPLAY_LAZYBINDING` to your CMakeLists.txt:
  ```cmake
  add_definitions(-DSRDISPLAY_LAZYBINDING)
  ```
- Ensure your include paths are correct
- Check that you're using SDK 1.34.8-RC1 or later

### Runtime Errors

**Debugging steps:**
- Verify SDK version compatibility (1.34.8-RC1+)
- Add validity checks around display usage:
  ```cpp
  if (display.isDisplayValid()) {
      // Use display safely
  }
  ```
- Check console output for DisplayAccess initialization messages
- Verify both old and new runtimes are available

### Need to Revert Migration?

**Easy rollback:**
```cmd
REM Delete migrated files
del main.cpp display_helper.h

REM Restore original files
ren main.cpp.legacy main.cpp
```

Or use your version control system:
```cmd
git restore .
```

## Additional Documentation

This package includes:
- **QUICKSTART.txt** - Quick reference for getting started
- **README.md** - This comprehensive guide
- **CHANGELOG.md** - Version history and changes

## Support

For technical details about the modern DisplayManager API and migration patterns, see the main repository documentation.

## Version

**Current Version**: 1.2.0 (Two Migration Modes)
- Modern mode (default): Direct IDisplayManager migration
- Legacy fallback mode: Backward-compatible with older runtimes
- Use `--legacy-fallback` flag for backward compatibility
- Clean, modern code output in default mode

## License

Copyright (c) 2025 Leia Inc.
